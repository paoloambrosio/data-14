= Database storage =

*At first we can will store the entire backup on the database, but this is just a temporary solution.* Later we will probably write data on a file and let the database keep just the block informations (hash value, etc.).

The table where the inode blocks are stored:

{{{
CREATE TABLE blocks (
	inode integer,
	offset integer,
	revision integer,
	data blob,
	PRIMARY KEY ( inode, offset, revision )
);

CREATE INDEX inode_blocks ON blocks ( inode );
}}}

An example to test revision extraction query:

{{{
INSERT INTO blocks VALUES ( 1, 1, 1, 'A1' );
INSERT INTO blocks VALUES ( 1, 2, 1, 'B1' );
INSERT INTO blocks VALUES ( 1, 2, 2, 'B2' );
INSERT INTO blocks VALUES ( 1, 2, 3, 'B3' );
INSERT INTO blocks VALUES ( 1, 3, 4, 'C4' );
INSERT INTO blocks VALUES ( 2, 1, 5, 'a5' );
INSERT INTO blocks VALUES ( 2, 1, 6, 'a6' );
INSERT INTO blocks VALUES ( 2, 2, 7, 'b7' );
INSERT INTO blocks VALUES ( 2, 1, 8, 'a8' );
INSERT INTO blocks VALUES ( 1, 1, 9, 'A9' );

SELECT inode, offset, MAX(revision), data
	FROM blocks
	WHERE inode = 1
	GROUP BY inode, offset;

SELECT inode, offset, MAX(revision), data
	FROM blocks
	WHERE inode = 2
	GROUP BY inode, offset;

SELECT inode, offset, MAX(revision), data
	FROM blocks
	WHERE inode = 2 AND revision <= 7
	GROUP BY inode, offset;
}}}
